<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Big G TV Off Air</title>
<style>
  :root { --bg:#000; --fg:#fff; --muted:rgba(255,255,255,.7); }
  html, body { width:100%; height:100%; margin:0; background:var(--bg); color:var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; overflow:hidden; }
  /* Fullscreen stage */
  #stage { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; }
  /* Blurred animated background */
  #blur-bg{
    position:absolute; inset:-40px;
    background:
      radial-gradient(1200px 600px at 20% 20%, rgba(59,130,246,.35), transparent 60%),
      radial-gradient(1200px 600px at 80% 80%, rgba(16,185,129,.28), transparent 60%),
      radial-gradient(1200px 600px at 80% 15%, rgba(239,68,68,.22), transparent 60%);
    filter: blur(28px);
    transform: scale(1.1);
    animation: drift 16s ease-in-out infinite alternate;
    opacity:.9;
  }
  @keyframes drift{
    from { transform: scale(1.1) translate3d(-18px, -10px, 0); }
    to   { transform: scale(1.15) translate3d(18px, 12px, 0); }
  }
  #scrim { position:absolute; inset:0; background:rgba(0,0,0,.55); }

  /* Content layer */
  #content { position:relative; width:100%; height:100%; display:flex; flex-direction:column; }

  /* Header */
  #header{ padding:28px 36px 0 36px; display:flex; gap:18px; align-items:baseline; justify-content:space-between; }
  #wg-title{ font-size:38px; font-weight:800; letter-spacing:-0.02em; margin:0; }
  #wg-sub{ font-size:16px; color:var(--muted); margin-top:6px; }

  /* Body */
  #body{ flex:1; min-height:0; display:flex; align-items:center; justify-content:center; padding:18px 36px 36px 36px; }
  #media-wrap{
    position:relative;
    width:min(92vw, 1560px);
    height:min(62vh, 820px);
    border-radius:22px;
    overflow:hidden;
    box-shadow: 0 18px 60px rgba(0,0,0,.55);
    background:rgba(0,0,0,.35);
  }

  /* Slideshow image */
  #slide{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:contain;
    background:rgba(0,0,0,.25);
    opacity:1;
    transition: opacity .6s ease;
  }

  /* YouTube */
  #yt-embed{
    position:absolute; inset:0;
    width:100%; height:100%;
    border:0;
    display:none; /* offair default */
    background:#000;
  }

  /* Status pill */
  #status{
    position:absolute; left:18px; top:18px;
    padding:8px 12px;
    border-radius:999px;
    background:rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.14);
    font-size:12px;
    color:rgba(255,255,255,.85);
    backdrop-filter: blur(10px);
  }

  /* Debug box */
  #debug{
    position:fixed; left:16px; bottom:16px;
    width:min(720px, calc(100vw - 32px));
    max-height:40vh;
    overflow:auto;
    white-space:pre-wrap;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size:12px;
    line-height:1.35;
    padding:10px 12px;
    border-radius:12px;
    background:rgba(0,0,0,.75);
    border:1px solid rgba(255,255,255,.14);
    display:none;
  }
</style>
</head>
<body>
<div id="stage">
  <div id="blur-bg"></div>
  <div id="scrim"></div>

  <div id="content">
    <div id="header">
      <div>
        <h1 id="wg-title">Big G TV is Off Air (for now)</h1>
        <div id="wg-sub">Weâ€™ll switch to LIVE automatically when we go live.</div>
      </div>
    </div>

    <div id="body">
      <div id="media-wrap">
        <div id="status">OFF AIR</div>
        <img id="slide" alt="Off Air Slide" />
        <iframe id="yt-embed" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
      </div>
    </div>
  </div>
</div>

<div id="debug"></div>

<script>
(() => {
  // ======== CONFIG ========
  const CONFIG = {
    // Your channel ID:
    channelId: 'UCaR9jZW5TJNrSg7w70czrsw',

    // Slideshow
    slides: ['WGNS.png','BGTV.png','PTS.png','RWX.png'],
    slideMs: 6000,

    // Live probing (no API key): parse the channel /live page through a text proxy
    liveProbeMs: 6000,
    liveProbeTimeoutMs: 7000,
    // IMPORTANT: keep this HTTPS
    liveProxyPrefix: 'https://r.jina.ai/https://www.youtube.com/channel/',

    // YouTube embed tuning
    embedParams: 'autoplay=1&mute=1&playsinline=1&rel=0&modestbranding=1'
  };

  // ======== DEBUG ========
  const debugEl = document.getElementById('debug');
  const debugEnabled = (new URLSearchParams(location.search).get('debug') === '1') || (location.hash.includes('debug'));
  function showDebug(){ debugEl.style.display = 'block'; }
  function log(msg){
    if (!debugEnabled) return;
    showDebug();
    const ts = new Date().toLocaleTimeString();
    debugEl.textContent += `[${ts}] ${msg}\n`;
    debugEl.scrollTop = debugEl.scrollHeight;
  }
  // If anything errors, show it.
  window.addEventListener('error', (e) => {
    showDebug();
    debugEl.textContent += `\n[ERROR] ${e.message}\n`;
  });
  window.addEventListener('unhandledrejection', (e) => {
    showDebug();
    debugEl.textContent += `\n[REJECT] ${String(e.reason)}\n`;
  });

  // ======== ELEMENTS ========
  const statusEl = document.getElementById('status');
  const slideEl = document.getElementById('slide');
  const ytEl = document.getElementById('yt-embed');

  // ======== SLIDESHOW ========
  let slideIdx = 0;
  function setSlide(i){
    const src = CONFIG.slides[i] + '?v=' + Date.now();
    slideEl.style.opacity = '0';
    // load -> fade in
    const img = new Image();
    img.onload = () => {
      slideEl.src = src;
      requestAnimationFrame(() => slideEl.style.opacity = '1');
      log('slide OK ' + src);
    };
    img.onerror = () => {
      log('slide FAIL ' + src + ' (check file name + folder)');
      // Keep old slide; also show a black fallback
      slideEl.style.opacity = '1';
    };
    img.src = src;
  }
  function startSlideshow(){
    setSlide(slideIdx);
    setInterval(() => {
      if (mode !== 'offair') return;
      slideIdx = (slideIdx + 1) % CONFIG.slides.length;
      setSlide(slideIdx);
    }, CONFIG.slideMs);
  }

  // ======== LIVE DETECTION ========
  let mode = 'offair';
  let lastVideoId = '';
  function setMode(next){
    if (mode === next) return;
    mode = next;
    if (mode === 'live'){
      statusEl.textContent = 'LIVE';
      slideEl.style.display = 'none';
      ytEl.style.display = 'block';
      log('MODE -> LIVE');
    } else {
      statusEl.textContent = 'OFF AIR';
      ytEl.style.display = 'none';
      slideEl.style.display = 'block';
      log('MODE -> OFF AIR');
    }
  }

  function embedUrlForVideoId(vid){
    return `https://www.youtube.com/embed/${vid}?${CONFIG.embedParams}`;
  }
  function embedUrlForChannelLive(){
    // Fallback that sometimes goes stale; we still keep it as a backup.
    return `https://www.youtube.com/embed/live_stream?channel=${CONFIG.channelId}&${CONFIG.embedParams}`;
  }

  async function fetchText(url, timeoutMs){
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);
    try{
      const res = await fetch(url, { signal: ctrl.signal, cache:'no-store' });
      const txt = await res.text();
      return { ok: res.ok, status: res.status, text: txt };
    } finally {
      clearTimeout(t);
    }
  }

  function extractLiveVideoId(htmlText){
    // We try a few patterns seen in ytInitialPlayerResponse / microformat when live.
    // Strategy:
    // 1) If isLiveNow true is present, grab nearest videoId.
    let idx = htmlText.indexOf('"isLiveNow":true');
    if (idx !== -1){
      const slice = htmlText.slice(Math.max(0, idx-5000), idx+5000);
      const m = slice.match(/"videoId":"([a-zA-Z0-9_-]{11})"/);
      if (m) return m[1];
    }
    // 2) liveStreamability / LIVE_STREAM_OFFLINE markers sometimes exist; still look for videoId in player response.
    idx = htmlText.indexOf('ytInitialPlayerResponse');
    if (idx !== -1){
      const slice = htmlText.slice(idx, idx + 20000);
      const m = slice.match(/"videoId":"([a-zA-Z0-9_-]{11})"/);
      if (m) return m[1];
    }
    // 3) generic: if the /live page is actively a watch page, it often includes "watch?v=<id>"
    const m2 = htmlText.match(/watch\?v=([a-zA-Z0-9_-]{11})/);
    if (m2) return m2[1];
    return '';
  }

  async function probeLive(){
    const url = CONFIG.liveProxyPrefix + CONFIG.channelId + '/live';
    const res = await fetchText(url, CONFIG.liveProbeTimeoutMs);
    log(`probe ${res.status} ${url}`);
    if (!res.ok) return '';
    const vid = extractLiveVideoId(res.text);
    if (vid && vid.length === 11) return vid;
    return '';
  }

  let probing = false;
  async function liveLoop(){
    if (probing) return;
    probing = true;
    try{
      // Always keep the channel-live embed loaded as a fallback
      if (!ytEl.src) ytEl.src = embedUrlForChannelLive();

      const vid = await probeLive();
      if (vid){
        if (vid !== lastVideoId){
          lastVideoId = vid;
          ytEl.src = embedUrlForVideoId(vid);
          log('SWITCH iframe -> videoId ' + vid);
        }
        setMode('live');
      } else {
        // If probe says no live, go offair.
        // (If you want it to "linger" longer, we can add hysteresis.)
        setMode('offair');
      }
    } catch(e){
      showDebug();
      log('probe error: ' + (e && e.name ? e.name : String(e)));
      // never brick: stay offair with slideshow
      setMode('offair');
    } finally {
      probing = false;
    }
  }

  // If tab becomes visible, do an immediate check.
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) liveLoop();
  });

  // ======== BOOT ========
  log('boot ok');
  startSlideshow();
  liveLoop();
  setInterval(liveLoop, CONFIG.liveProbeMs);
})();
</script>
</body>
</html>
