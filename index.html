<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Big G TV Lobby</title>
<style>
:root { --bg:#0b1220; --panel:rgba(255,255,255,.92); --border:rgba(255,255,255,.14); --text:#0f172a; --radius:18px; --shadow:0 18px 48px rgba(0,0,0,.25); }
html,body{background:var(--bg);min-height:100vh;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
body{background:var(--bg);min-height:100vh;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
body::before{
  content:"";
  position:absolute; inset:-18%;
  background:
    radial-gradient(1200px 600px at 15% 10%, rgba(239,68,68,.24), transparent 60%),
    radial-gradient(900px 520px at 85% 20%, rgba(249,115,22,.18), transparent 55%),
    radial-gradient(1100px 700px at 50% 100%, rgba(59,130,246,.12), transparent 60%);
  filter: blur(28px);
  transform: translate3d(0,0,0) scale(1.10);
  animation: bgDrift 18s ease-in-out infinite alternate;
  z-index:-1;
}
body::after{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(1200px 700px at 50% 40%, rgba(0,0,0,0), rgba(0,0,0,.30));
  z-index:-1;
}
@keyframes bgDrift{
  0%   { transform: translate3d(-2.5%, -1.5%, 0) scale(1.10); opacity:.95; }
  50%  { transform: translate3d(2.5%, 1.2%, 0) scale(1.12); opacity:1; }
  100% { transform: translate3d(-1.0%, 2.0%, 0) scale(1.11); opacity:.97; }
}
.wg-app{width:100vw;height:100vh;background:transparent;border:none;border-radius:0;box-shadow:none;overflow:hidden;display:flex;flex-direction:column;}
.wg-header{position:absolute;top:0;left:0;right:0;z-index:10;display:flex;align-items:center;gap:12px;padding:16px 18px;background:rgba(0,0,0,.35);backdrop-filter:blur(10px);}
.wg-title{font-size:clamp(18px,2.2vw,26px);font-weight:900;letter-spacing:-.02em;color:rgba(255,255,255,.95);text-shadow:0 1px 12px rgba(0,0,0,.35);}
.wg-spacer{margin-left:auto}
.wg-badge{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.18);color:rgba(255,255,255,.9);font-weight:700;}
.dot{width:9px; height:9px; border-radius:99px; background:#9ca3af}
.dot.live{background:#22c55e}
.wg-body{padding:0;flex:1 1 auto;min-height:0;display:flex;}
.wg-stage{position:relative;width:100%;height:100%;overflow:hidden;background:#000;}
.wg-video{ position:absolute; inset:0; opacity:0; transition: opacity .7s ease-in-out; }
.wg-video.is-on{opacity:1}
#yt-holder, #yt-holder iframe{position:absolute; inset:0; width:100%; height:100%; border:none}
.wg-slideshow{ position:absolute; inset:0; opacity:1; transition: opacity .7s ease-in-out; }
.wg-slideshow.is-off{opacity:0; pointer-events:none}
.wg-slideshow::after{
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(900px 540px at 50% 45%, rgba(255,255,255,.10), transparent 60%),
    radial-gradient(1200px 700px at 20% 20%, rgba(239,68,68,.10), transparent 60%),
    radial-gradient(1000px 700px at 80% 70%, rgba(59,130,246,.10), transparent 60%);
  pointer-events:none;
  mix-blend-mode:soft-light;
  z-index:3;
}
.wg-slide{ position:absolute; inset:0; opacity:0; transition: opacity 1.2s ease-in-out; z-index:1; }
.wg-slide.is-active{opacity:1}
.wg-slide::before{
  content:"";
  position:absolute; inset:-4%;
  background-image: var(--bgimg);
  background-size:cover;
  background-position:center;
  transform:scale(1);
  filter:saturate(1.02);
}
.wg-slide.is-active::before{ animation: wgPulse 6s ease-in-out infinite; }
@keyframes wgPulse { 0%{transform:scale(1)} 50%{transform:scale(1.04)} 100%{transform:scale(1)} }
.wg-slide::after{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(900px 600px at 50% 50%, transparent 45%, rgba(0,0,0,.28));
  pointer-events:none;
  z-index:2;
}
.wg-debug{top:auto;bottom:12px;
  position:absolute; left:12px; bottom:12px;
  padding:10px 12px; border-radius:12px;
  background:rgba(0,0,0,.55);
  color:rgba(255,255,255,.92);
  font: 12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  display:none; z-index:10; white-space:pre-wrap;
}
.wg-debug.on{display:block}
</style>
</head>
<body>
<main class="wg-app">
  <header class="wg-header">
    <div class="wg-title" id="wg-title">Big G TV is Off Air (for now)</div>
    <div class="wg-spacer"></div>
    <div class="wg-badge">
      <span class="dot" id="wg-dot"></span>
      <span id="wg-live-text">Off Air</span>
    </div>
  </header>

  <section class="wg-body">
    <div class="wg-stage">
      <div class="wg-video" id="wg-video">
        <div id="yt-holder">
          <iframe id="yt-embed" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
        </div>
      </div>
      <div class="wg-slideshow" id="wg-slideshow"></div>
      <div class="wg-debug" id="wg-debug"></div>
    </div>
  </section>
</main>

<script>

(() => {
  // Big G TV Off Air / Live Auto-Switch (fixed: auto-detect without manual refresh)
  const CACHE_BUST = '1767573023';

  const config = {
    channelId: 'UCaR9jZW5TJNrSg7w70czrsw',
    // While Off Air, we periodically reload the embed to force YouTube to pick up a newly-started live stream.
    iframeReloadMs: 9000,
    // How often we sample the player for "is it live?" evidence.
    detectPollMs: 900,
    // How long evidence must be present before we commit to LIVE (prevents flapping).
    settleLiveMs: 2500,
    // If we're in LIVE mode but the player is stuck/unplayable for this long, force a reload.
    stuckLiveMs: 8000,
    slides: [
      'WGNS.png?v=' + CACHE_BUST,
      'BGTV.png?v=' + CACHE_BUST,
      'PTS.png?v=' + CACHE_BUST,
      'RWX.png?v=' + CACHE_BUST
    ],
    slideSeconds: 8
  };

  // --- Live detection via YouTube /live page (CORS-friendly through r.jina.ai) ---
  const JINA_PREFIX = 'https://r.jina.ai/https://';
  const LIVE_PAGE_URL = `https://www.youtube.com/channel/${config.channelId}/live`;

  async function fetchLiveVideoId(){
    try{
      const res = await fetch(JINA_PREFIX + LIVE_PAGE_URL.replace('https://',''), { cache:'no-store' });
      if(!res.ok) return null;
      const txt = await res.text();

      // Prefer explicit live marker
      const liveIdx = txt.indexOf('"isLiveContent":true');
      if(liveIdx !== -1){
        const win = txt.slice(Math.max(0, liveIdx-2500), liveIdx+5000);
        const m = win.match(/"videoId":"([a-zA-Z0-9_-]{11})"/);
        if(m) return m[1];
      }
      // Fallback: first watch link
      const m2 = txt.match(/\/watch\?v=([a-zA-Z0-9_-]{11})/);
      return m2 ? m2[1] : null;
    }catch(e){
      return null;
    }
  }

  function videoEmbedSrc(videoId){
    return 'https://www.youtube-nocookie.com/embed/' + encodeURIComponent(videoId)
      + '?autoplay=1&mute=1&playsinline=1&rel=0&modestbranding=1&enablejsapi=1'
      + '&_=' + Date.now();
  }


  // DOM
  const app = document.querySelector('.wg-app');
  const slideshowWrap = document.getElementById('wg-slideshow');
  const videoWrap = document.getElementById('wg-video');
  const dot = document.getElementById('wg-dot');
  const liveTxt = document.getElementById('wg-live-text');
  const titleEl = document.getElementById('wg-title');
  const dbg = document.getElementById('wg-debug');

  // State
  let mode = 'offair';
  let activeIdx = 0;
  let slideTimer = null;

  let ytReady = false;
  let player = null;
  let detectTimer = null;
  let reloadTimer = null;

  let lastPlayableAt = 0;
  let lastReloadAt = 0;
  let liveEvidenceStartedAt = null;

  // Debug toggle (?debug=1)
  const debugOn = /[?&]debug=1/i.test(location.search);
  if (!debugOn) dbg.style.display = 'none';

  function log(msg){
    if (!debugOn) return;
    const ts = new Date().toLocaleTimeString();
    dbg.textContent = '[' + ts + '] ' + msg + '
' + (dbg.textContent || '');
  }

  function setUI(live){
    dot.classList.toggle('live', !!live);
    liveTxt.textContent = live ? 'LIVE' : 'Off Air';
    titleEl.textContent = live ? 'Big G TV â€¢ LIVE' : 'Big G TV is Off Air (for now)';
    videoWrap.classList.toggle('is-on', !!live);
    slideshowWrap.classList.toggle('is-off', !!live);
  }

  function setMode(next){
    if (mode === next) return;
    mode = next;
    setUI(mode === 'live');
    log('mode -> ' + mode);
    if (mode === 'live') {
      stopSlideshow();
    } else {
      startSlideshow();
    }
  }

  // Slideshow
  function renderSlides(){
    const frag = document.createDocumentFragment();
    config.slides.forEach((src, i) => {
      const d = document.createElement('div');
      d.className = 'wg-slide' + (i === 0 ? ' is-active' : '');
      const img = document.createElement('img');
      img.alt = '';
      img.loading = 'eager';
      img.decoding = 'async';
      img.src = src;
      d.appendChild(img);
      frag.appendChild(d);
    });
    slideshowWrap.innerHTML = '';
    slideshowWrap.appendChild(frag);
  }

  function startSlideshow(){
    stopSlideshow();
    const slides = Array.from(slideshowWrap.querySelectorAll('.wg-slide'));
    if (!slides.length) return;
    slides.forEach((s,i)=>s.classList.toggle('is-active', i===activeIdx));
    slideTimer = setInterval(() => {
      const prev = activeIdx;
      activeIdx = (activeIdx + 1) % slides.length;
      slides[prev].classList.remove('is-active');
      slides[activeIdx].classList.add('is-active');
    }, Math.max(2000, config.slideSeconds * 1000));
  }
  function stopSlideshow(){ if (slideTimer) { clearInterval(slideTimer); slideTimer=null; } }

  // YouTube embed helpers
  function liveIframeSrc(){
    return 'https://www.youtube-nocookie.com/embed/live_stream?channel='
      + encodeURIComponent(config.channelId)
      + '&autoplay=1&mute=1&playsinline=1&rel=0&modestbranding=1&enablejsapi=1'
      + '&_=' + Date.now();
  }

  const iframeEl = document.getElementById('yt-embed');

  
  let lastLiveVideoId = null;
  let livePageLastCheck = 0;
function destroyPlayer(){
    if (!player) return;
    try { player.destroy(); } catch(_e){}
    player = null;
  }

  function buildPlayer(){
    if (!ytReady) return;
    if (player) return;
    try {
      player = new YT.Player('yt-embed', {
        events: {
          onReady: (e) => {
            log('YT ready');
            try { e.target.mute(); } catch(_e){}
            try { e.target.playVideo(); } catch(_e){}
          },
          onStateChange: (e) => {
            log('onStateChange=' + e.data);
            // 1 = playing, 3 = buffering
            if (e.data === 1 || e.data === 3) lastPlayableAt = Date.now();
          },
          onError: (e) => {
            log('onError=' + e.data);
          }
        }
      });
      return;
    } catch (e) {
      log('YT init threw');
    }
  }

  function refreshEmbed(reason, videoId){
    lastReloadAt = Date.now();
    log('refreshEmbed: ' + reason + (videoId ? (' vid=' + videoId) : ''));
    destroyPlayer();
    iframeEl.src = videoId ? videoEmbedSrc(videoId) : liveIframeSrc();
    setTimeout(buildPlayer, 250);
  }

  // Live detection logic
  function isRealVideoId(vid){
    if (!vid) return false;
    // YouTube uses a real 11-char id for live videos; empty/undefined when off air.
    return typeof vid === 'string' && vid.length >= 8 && vid !== 'live_stream';
  }

  function detectLive(){
    // If player isn't ready yet, we can't reliably detect. We'll rely on the reload loop.
    if (!player || typeof player.getPlayerState !== 'function') return;

    let st = null;
    let vid = null;

    try { st = player.getPlayerState(); } catch(_e){}
    try {
      const vd = player.getVideoData && player.getVideoData();
      vid = vd && (vd.video_id || vd.videoId || vd.video_id);
    } catch(_e){}

    const liveByState = (st === 1 || st === 3);
    const liveByVid = isRealVideoId(vid);

    log('state=' + st + ' vid=' + (vid || '(none)') + ' liveByState=' + liveByState + ' liveByVid=' + liveByVid);

    const hasEvidence = liveByState || liveByVid;

    if (hasEvidence) {
      lastPlayableAt = Date.now();
      if (!liveEvidenceStartedAt) liveEvidenceStartedAt = Date.now();
      const elapsed = Date.now() - liveEvidenceStartedAt;
      if (elapsed >= config.settleLiveMs) {
        setMode('live');
      }
    } else {
      liveEvidenceStartedAt = null;
      // If we were live but evidence disappears, drop back to offair (after a short grace).
      if (mode === 'live') setMode('offair');
    }

    // If we think we're live but nothing has been playable recently, force a reload.
    if (mode === 'live') {
      const sincePlayable = Date.now() - (lastPlayableAt || 0);
      if (sincePlayable > config.stuckLiveMs) {
        refreshEmbed('stuck_live_' + Math.round(sincePlayable/1000) + 's');
      }
    }
  }

  function startLoops(){
    if (!detectTimer) detectTimer = setInterval(detectLive, config.detectPollMs);

    if (!reloadTimer) {
      reloadTimer = setInterval(() => {
        // While off air, periodically refresh the embed so it will pick up a newly-started live stream automatically.
        if (mode !== 'offair') return;

        const sinceReload = Date.now() - (lastReloadAt || 0);
        if (sinceReload >= config.iframeReloadMs) {
          refreshEmbed('offair_poll');
        }
      
        // Also poll the channel /live page every ~5s. This catches new lives even when the live_stream embed is stale.
        const now = Date.now();
        if (now - livePageLastCheck >= 5000) {
          livePageLastCheck = now;
          fetchLiveVideoId().then((vid) => {
            if (vid && vid !== lastLiveVideoId) {
              lastLiveVideoId = vid;
              refreshEmbed('live_page_poll', vid);
              setMode('live');
            } else if (!vid) {
              lastLiveVideoId = null;
              if (mode === 'live') {
                // if the live ended, drop back
                refreshEmbed('live_ended_reset');
                setMode('offair');
              }
            }
          });
        }

      }, 800); // lightweight heartbeat
    }
  }

  // When tab becomes visible again, immediately refresh.
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden){
      refreshEmbed('tab_visible');
      fetchLiveVideoId().then((vid)=>{ if(vid){ lastLiveVideoId = vid; refreshEmbed('tab_visible_live', vid); setMode('live'); } });
    }
  });

  // Boot
  renderSlides();
  setMode('offair');
  startSlideshow();

  // Load YT IFrame API
  const s = document.createElement('script');
  s.src = 'https://www.youtube.com/iframe_api';
  s.async = true;
  document.head.appendChild(s);

  window.onYouTubeIframeAPIReady = () => {
    ytReady = true;
    log('YT IFrame API ready');
    // First load immediately
    refreshEmbed('yt_api_ready');
    startLoops();
  };

  // Safety fallback: if YT API is blocked/slow, still keep refreshing iframe src so it will flip without manual refresh.
  setTimeout(() => {
    if (!ytReady) {
      log('YT API fallback start');
      refreshEmbed('fallback');
      startLoops();
    }
  }, 2500);

})();
</script>
</body>
</html>
