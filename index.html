<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WGNS / Big G TV Lobby</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{ --bg:#000; --fade:900ms; }
    html, body { height:100%; margin:0; background:var(--bg); overflow:hidden; }
    #wrap { position:relative; width:100%; height:100%; background:var(--bg); }
    #playerLayer, #slideshowLayer { position:absolute; inset:0; }
    #slideshowLayer { display:block; background:var(--bg); }
    #playerLayer { display:none; background:var(--bg); }

    #slideshowLayer img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      opacity:0;
      transition: opacity var(--fade) linear;
    }
    #slideshowLayer img.show{ opacity:1; }

    #badge{
      position:absolute; left:18px; bottom:18px;
      padding:8px 10px; border-radius:12px;
      background:rgba(0,0,0,.55);
      color:#fff;
      font:600 14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      letter-spacing:.2px; user-select:none;
      backdrop-filter: blur(6px);
      z-index: 10;
    }
    #badge small{ display:block; opacity:.75; font-weight:500; margin-top:2px; }
    #badge.offline::before{ content:"● "; color:#ff5252; }
    #badge.online::before{ content:"● "; color:#35d07f; }

    #twitch-embed, iframe { width:100% !important; height:100% !important; }
  </style>

  <script src="https://player.twitch.tv/js/embed/v1.js"></script>
</head>
<body>
  <div id="wrap">
    <div id="slideshowLayer"></div>

    <div id="playerLayer">
      <div id="twitch-embed"></div>
    </div>

    <div id="badge" class="offline">OFFLINE<small>Showing lobby loop</small></div>
  </div>

  <script>
    // ===================== CONFIG =====================
    const CONFIG = {
      channel: "wgnsbiggtv",

      // Images in SAME folder as index.html
      slides: ["WGNS.png","BGTV.png","PTS.png","RWX.png"],
      slideMs: 10000,

      // How often to check live status
      pollMs: 15000,

      // Player behavior
      // IMPORTANT: leave muted=true for lobby TVs so autoplay ALWAYS works.
      muted: true,
      volume: 0.5,

      // After switching to live, verify playback (time advances). If not, retry a couple times.
      playbackCheckDelayMs: 2500,
      maxPlaybackRetries: 2,

      showBadge: true,
    };

    // ===================== DOM =====================
    const slideshowLayer = document.getElementById("slideshowLayer");
    const playerLayer = document.getElementById("playerLayer");
    const badge = document.getElementById("badge");

    function setBadge(state, note){
      if (!CONFIG.showBadge) { badge.style.display = "none"; return; }
      badge.style.display = "block";
      badge.classList.toggle("online", state === "online");
      badge.classList.toggle("offline", state !== "online");
      badge.childNodes[0].nodeValue = (state === "online" ? "LIVE" : "OFFLINE");
      badge.querySelector("small").textContent = note || (state === "online" ? "Playing Twitch stream" : "Showing lobby loop");
    }

    // ===================== SLIDESHOW =====================
    let slideEls = [];
    let slideIdx = 0;
    let slideTimer = null;

    function buildSlides(){
      slideshowLayer.innerHTML = "";
      slideEls = CONFIG.slides.map(src => {
        const img = document.createElement("img");
        img.src = src;
        img.alt = "";
        slideshowLayer.appendChild(img);
        return img;
      });
      slideIdx = 0;
      if (slideEls[0]) slideEls[0].classList.add("show");
    }

    function startSlideshow(){
      if (slideTimer) return;
      if (!slideEls.length) buildSlides();
      slideTimer = setInterval(() => {
        if (!slideEls.length) return;
        slideEls[slideIdx].classList.remove("show");
        slideIdx = (slideIdx + 1) % slideEls.length;
        slideEls[slideIdx].classList.add("show");
      }, CONFIG.slideMs);
    }

    function stopSlideshow(){
      if (slideTimer) clearInterval(slideTimer);
      slideTimer = null;
    }

    // ===================== VIEW TOGGLE =====================
    function showOffline(note){
      playerLayer.style.display = "none";
      slideshowLayer.style.display = "block";
      startSlideshow();
      setBadge("offline", note || "Showing lobby loop");
      destroyPlayer(); // removes the “last stream title/date” UI completely
    }

    function showOnline(note){
      slideshowLayer.style.display = "none";
      playerLayer.style.display = "block";
      stopSlideshow();
      setBadge("online", note || "Playing Twitch stream");
    }

    // ===================== LIVE CHECK (CORS-safe) =====================
    async function isTwitchLive(channel){
      // Cache-buster to avoid stale results
      const bust = Date.now();
      const url = `https://r.jina.ai/https://www.twitch.tv/${encodeURIComponent(channel)}?cb=${bust}`;
      try{
        const res = await fetch(url, { cache: "no-store" });
        const text = await res.text();

        // Look for JSON-LD flag:
        if (text.includes('"isLiveBroadcast":true') || text.includes('"isLiveBroadcast": true')) return true;
        if (text.includes('"isLiveBroadcast":false') || text.includes('"isLiveBroadcast": false')) return false;

        return null;
      }catch(e){
        return null;
      }
    }

    // ===================== TWITCH PLAYER =====================
    let player = null;

    function parentDomains(){
      const host = window.location.hostname;
      return host ? [host] : [];
    }

    function createPlayer(){
      document.getElementById("twitch-embed").innerHTML = "";
      player = new Twitch.Player("twitch-embed", {
        channel: CONFIG.channel,
        parent: parentDomains(),
        autoplay: true,
        muted: CONFIG.muted, // keep this true for reliable autoplay
      });
      try { player.setVolume(CONFIG.volume); } catch(e) {}
    }

    function destroyPlayer(){
      document.getElementById("twitch-embed").innerHTML = "";
      player = null;
    }

    function iframeLooksVod(){
      const iframe = document.querySelector("#twitch-embed iframe");
      const src = iframe?.getAttribute("src") || "";
      return src.includes("video=") || src.includes("/videos/");
    }

    async function confirmPlayback(){
      if (!player) return false;

      // If it’s clearly a VOD link, reject
      if (iframeLooksVod()) return false;

      // Try to see if current time advances
      const t1 = safeGet(() => player.getCurrentTime?.(), 0);
      await sleep(900);
      const t2 = safeGet(() => player.getCurrentTime?.(), 0);
      await sleep(900);
      const t3 = safeGet(() => player.getCurrentTime?.(), 0);

      return (t2 > t1 + 0.2) || (t3 > t2 + 0.2) || (t3 > t1 + 0.5);
    }

    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
    function safeGet(fn, fallback){
      try{
        const v = fn();
        return (typeof v === "number" && isFinite(v)) ? v : fallback;
      }catch(e){
        return fallback;
      }
    }

    // ===================== STATE =====================
    let mode = "offline";
    let playbackRetries = 0;
    let switching = false;

    async function goLive(){
      if (switching) return;
      switching = true;
      playbackRetries = 0;

      showOnline("LIVE (starting player…)"); // show immediately
      createPlayer();

      // Verify playback & retry if needed
      while (playbackRetries <= CONFIG.maxPlaybackRetries) {
        await sleep(CONFIG.playbackCheckDelayMs);
        const ok = await confirmPlayback();
        if (ok) {
          setBadge("online", "Playing Twitch stream");
          switching = false;
          mode = "online";
          return;
        }
        playbackRetries++;
        // If not confirmed, recreate player (common fix for embed getting “stuck”)
        createPlayer();
      }

      // Could not confirm playback → treat as offline
      showOffline("Offline (no playback)");
      mode = "offline";
      switching = false;
    }

    function goOffline(reason){
      mode = "offline";
      showOffline(reason || "Confirmed OFFLINE");
    }

    // ===================== INIT =====================
    (function init(){
      buildSlides();
      goOffline("Checking stream status…");

      setInterval(async () => {
        const live = await isTwitchLive(CONFIG.channel);

        if (live === true) {
          if (mode !== "online") await goLive();
        } else if (live === false) {
          if (mode !== "offline") goOffline("Confirmed OFFLINE");
          else setBadge("offline", "Confirmed OFFLINE");
        } else {
          // Unknown → safest is slideshow
          if (mode !== "offline") goOffline("Status unknown — showing loop");
          else setBadge("offline", "Status unknown — showing loop");
        }
      }, CONFIG.pollMs);

      // Press F for fullscreen
      document.addEventListener("keydown", (e) => {
        if (e.key.toLowerCase() === "f") {
          if (!document.fullscreenElement) document.documentElement.requestFullscreen?.();
          else document.exitFullscreen?.();
        }
      });
    })();
  </script>
</body>
</html>
