<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WGNS / Big G TV Lobby</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{ --bg:#000; --fade: 900ms; }
    html, body { height:100%; margin:0; background:var(--bg); overflow:hidden; }
    #wrap { position:relative; width:100%; height:100%; background:var(--bg); }
    #playerLayer, #slideshowLayer { position:absolute; inset:0; }
    #slideshowLayer { display:block; background:var(--bg); }
    #playerLayer { display:none; background:var(--bg); }

    #slideshowLayer img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      opacity:0;
      transition: opacity var(--fade) linear;
    }
    #slideshowLayer img.show{ opacity:1; }

    #badge{
      position:absolute; left:18px; bottom:18px;
      padding:8px 10px; border-radius:12px;
      background:rgba(0,0,0,.55);
      color:#fff;
      font: 600 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      letter-spacing:.2px; user-select:none;
      backdrop-filter: blur(6px);
      z-index: 10;
    }
    #badge small{ display:block; opacity:.75; font-weight:500; margin-top:2px; }
    #badge.offline::before{ content:"● "; color:#ff5252; }
    #badge.online::before{ content:"● "; color:#35d07f; }

    #twitch-embed, iframe { width:100% !important; height:100% !important; }
  </style>

  <script src="https://player.twitch.tv/js/embed/v1.js"></script>
</head>
<body>
  <div id="wrap">
    <div id="slideshowLayer" aria-label="Offline slideshow"></div>

    <div id="playerLayer" aria-label="Twitch player">
      <div id="twitch-embed"></div>
    </div>

    <div id="badge" class="offline">OFFLINE<small>Showing lobby loop</small></div>
  </div>

  <script>
    // ===================== CONFIG =====================
    const CONFIG = {
      channel: "wgnsbiggtv",

      // Images in same folder as index.html
      slides: ["WGNS.png","BGTV.png","PTS.png","RWX.png"],
      slideMs: 10000,

      // How often to check Twitch page for live status
      pollMs: 20000,

      // If live, recreate player occasionally to keep it healthy
      onlineRecreateMs: 10 * 60 * 1000, // 10 minutes

      muted: false,
      volume: 0.5,
      showBadge: true,
    };

    // ===================== DOM =====================
    const slideshowLayer = document.getElementById("slideshowLayer");
    const playerLayer = document.getElementById("playerLayer");
    const badge = document.getElementById("badge");

    function setBadge(state, note){
      if (!CONFIG.showBadge) { badge.style.display = "none"; return; }
      badge.style.display = "block";
      badge.classList.toggle("online", state === "online");
      badge.classList.toggle("offline", state !== "online");
      badge.childNodes[0].nodeValue = (state === "online" ? "LIVE" : "OFFLINE");
      badge.querySelector("small").textContent = note || (state === "online" ? "Playing Twitch stream" : "Showing lobby loop");
    }

    // ===================== SLIDESHOW =====================
    let slideEls = [];
    let slideIdx = 0;
    let slideTimer = null;

    function buildSlides(){
      slideshowLayer.innerHTML = "";
      slideEls = CONFIG.slides.map(src => {
        const img = document.createElement("img");
        img.src = src;
        img.alt = "";
        slideshowLayer.appendChild(img);
        return img;
      });
      slideIdx = 0;
      if (slideEls[0]) slideEls[0].classList.add("show");
    }

    function startSlideshow(){
      if (slideTimer) return;
      if (!slideEls.length) buildSlides();
      slideTimer = setInterval(() => {
        if (!slideEls.length) return;
        slideEls[slideIdx].classList.remove("show");
        slideIdx = (slideIdx + 1) % slideEls.length;
        slideEls[slideIdx].classList.add("show");
      }, CONFIG.slideMs);
    }

    function stopSlideshow(){
      if (slideTimer) clearInterval(slideTimer);
      slideTimer = null;
    }

    // ===================== VIEW TOGGLE =====================
    function showOffline(note){
      // IMPORTANT: hide Twitch completely so it can't show "last stream" UI
      playerLayer.style.display = "none";
      slideshowLayer.style.display = "block";
      startSlideshow();
      setBadge("offline", note || "Showing lobby loop");
    }

    function showOnline(note){
      slideshowLayer.style.display = "none";
      playerLayer.style.display = "block";
      stopSlideshow();
      setBadge("online", note || "Playing Twitch stream");
    }

    // ===================== TWITCH PLAYER =====================
    let player = null;

    function parentDomains(){
      const host = window.location.hostname;
      return host ? [host] : [];
    }

    function createPlayer(){
      document.getElementById("twitch-embed").innerHTML = "";
      player = new Twitch.Player("twitch-embed", {
        channel: CONFIG.channel,
        parent: parentDomains(),
        autoplay: true,      // ONLY created when we already confirmed live
        muted: CONFIG.muted,
      });
      try { player.setVolume(CONFIG.volume); } catch(e) {}
    }

    // ===================== LIVE CHECK (CORS-safe) =====================
    async function isTwitchLive(channel){
      // Use a text proxy so GitHub Pages can fetch the channel page source
      const url = `https://r.jina.ai/https://www.twitch.tv/${encodeURIComponent(channel)}`;
      try{
        const res = await fetch(url, { cache: "no-store" });
        const text = await res.text();

        // Twitch page includes JSON-LD with "isLiveBroadcast": true/false
        // We'll check for the true case.
        if (text.includes('"isLiveBroadcast":true') || text.includes('"isLiveBroadcast": true')) return true;
        if (text.includes('"isLiveBroadcast":false') || text.includes('"isLiveBroadcast": false')) return false;

        // If we can’t find it, treat as unknown -> don't show player
        return null;
      } catch(e){
        return null;
      }
    }

    // ===================== MODE CONTROL =====================
    let mode = "offline";
    let onlineRecreateTimer = null;

    function goOffline(reason){
      mode = "offline";
      // Kill player DOM so it can’t display the old stream header
      document.getElementById("twitch-embed").innerHTML = "";
      player = null;

      if (onlineRecreateTimer) clearInterval(onlineRecreateTimer);
      onlineRecreateTimer = null;

      showOffline(reason);
    }

    function goOnline(reason){
      mode = "online";
      showOnline(reason);
      createPlayer();

      // keep it healthy if it's up for hours
      if (!onlineRecreateTimer){
        onlineRecreateTimer = setInterval(() => {
          if (mode === "online") createPlayer();
        }, CONFIG.onlineRecreateMs);
      }
    }

    // ===================== INIT =====================
    (function init(){
      buildSlides();
      goOffline("Checking stream status…");

      // Poll loop
      setInterval(async () => {
        const live = await isTwitchLive(CONFIG.channel);

        if (live === true && mode !== "online") {
          goOnline("Confirmed LIVE");
        } else if (live === false && mode !== "offline") {
          goOffline("Confirmed OFFLINE");
        } else if (live === null) {
          // unknown — safest behavior is: stay offline (slideshow)
          if (mode !== "offline") goOffline("Status unknown (network) — showing loop");
          else setBadge("offline", "Status unknown (network) — showing loop");
        }
      }, CONFIG.pollMs);

      // Fullscreen hotkey
      document.addEventListener("keydown", (e) => {
        if (e.key.toLowerCase() === "f") {
          if (!document.fullscreenElement) document.documentElement.requestFullscreen?.();
          else document.exitFullscreen?.();
        }
      });
    })();
  </script>
</body>
</html>
