<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Big G TV Lobby</title>
<style>
:root {
  --bg:#0b1220;
  --panel:rgba(255,255,255,.92);
  --border:rgba(255,255,255,.14);
  --text:#0f172a;
  --radius:18px;
  --shadow:0 18px 48px rgba(0,0,0,.25);
}
html,body{height:100%}
body{
  margin:0; min-height:100vh;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  color:var(--text);
  background: var(--bg);
  display:grid; place-items:center;
  padding:clamp(14px,3vw,28px);
  box-sizing:border-box;
  position:relative;
  overflow:hidden;
}
/* Animated blur background */
body::before{
  content:"";
  position:absolute; inset:-18%;
  background:
    radial-gradient(1200px 600px at 15% 10%, rgba(239,68,68,.24), transparent 60%),
    radial-gradient(900px 520px at 85% 20%, rgba(249,115,22,.18), transparent 55%),
    radial-gradient(1100px 700px at 50% 100%, rgba(59,130,246,.12), transparent 60%);
  filter: blur(28px);
  transform: translate3d(0,0,0) scale(1.10);
  animation: bgDrift 18s ease-in-out infinite alternate;
  z-index:-1;
}
body::after{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(1200px 700px at 50% 40%, rgba(0,0,0,0), rgba(0,0,0,.30));
  z-index:-1;
}
@keyframes bgDrift{
  0%   { transform: translate3d(-2.5%, -1.5%, 0) scale(1.10); opacity:.95; }
  50%  { transform: translate3d(2.5%, 1.2%, 0) scale(1.12); opacity:1; }
  100% { transform: translate3d(-1.0%, 2.0%, 0) scale(1.11); opacity:.97; }
}

.wg-app{
  width:min(1200px,100%);
  height:min(720px,100%);
  max-height:calc(100vh - clamp(28px, 6vw, 56px));
  background:linear-gradient(180deg,var(--panel),rgba(255,255,255,.86));
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex; flex-direction:column;
  backdrop-filter:blur(10px);
}
.wg-header{
  display:flex; align-items:center; gap:14px;
  padding:14px 16px;
  border-bottom:1px solid rgba(15,23,42,.08);
  background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.88));
  flex:0 0 auto;
}
.wg-title{font-weight:950; letter-spacing:-.02em; font-size:1.02rem; line-height:1.1}
.wg-spacer{margin-left:auto}
.wg-badge{
  display:inline-flex; align-items:center; gap:8px;
  padding:7px 10px; border-radius:999px;
  border:1px solid rgba(15,23,42,.10);
  background:rgba(255,255,255,.75);
  font-weight:900;
  color:rgba(15,23,42,.85);
}
.dot{width:9px; height:9px; border-radius:99px; background:#9ca3af}
.dot.live{background:#22c55e}
.wg-body{padding:16px; flex:1 1 auto; min-height:0; display:flex}

.wg-stage{
  position:relative;
  width:100%; height:100%;
  border-radius:16px;
  overflow:hidden;
  background:#000;
  border:1px solid rgba(15,23,42,.10);
}
.wg-video{
  position:absolute; inset:0;
  opacity:0;
  transition: opacity .7s ease-in-out;
}
.wg-video.is-on{opacity:1}
.wg-video iframe{position:absolute; inset:0; width:100%; height:100%; border:none}

.wg-slideshow{
  position:absolute; inset:0;
  opacity:1;
  transition: opacity .7s ease-in-out;
}
.wg-slideshow.is-off{opacity:0; pointer-events:none}
.wg-slideshow::after{
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(900px 540px at 50% 45%, rgba(255,255,255,.10), transparent 60%),
    radial-gradient(1200px 700px at 20% 20%, rgba(239,68,68,.10), transparent 60%),
    radial-gradient(1000px 700px at 80% 70%, rgba(59,130,246,.10), transparent 60%);
  pointer-events:none;
  mix-blend-mode:soft-light;
  z-index:3;
}

.wg-slide{
  position:absolute; inset:0;
  opacity:0;
  transition: opacity 1.2s ease-in-out;
  z-index:1;
}
.wg-slide.is-active{opacity:1}
.wg-slide::before{
  content:"";
  position:absolute; inset:-4%;
  background-image: var(--bgimg);
  background-size:cover;
  background-position:center;
  transform:scale(1);
  filter:saturate(1.02);
}
.wg-slide.is-active::before{ animation: wgPulse 6s ease-in-out infinite; }
@keyframes wgPulse { 0%{transform:scale(1)} 50%{transform:scale(1.04)} 100%{transform:scale(1)} }
.wg-slide::after{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(900px 600px at 50% 50%, transparent 45%, rgba(0,0,0,.28));
  pointer-events:none;
  z-index:2;
}

/* Debug HUD (enable with #debug in URL) */
.wg-debug{
  position:absolute; left:12px; bottom:12px;
  max-width:min(720px, calc(100% - 24px));
  padding:10px 12px;
  border-radius:12px;
  background:rgba(0,0,0,.55);
  color:rgba(255,255,255,.92);
  font: 12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  display:none;
  z-index:10;
  white-space:pre-wrap;
}
.wg-debug.on{display:block}

@media (prefers-reduced-motion: reduce){
  body::before{animation:none}
  .wg-slide{transition:none}
  .wg-slide.is-active::before{animation:none}
  .wg-video, .wg-slideshow{transition:none}
}
@media (max-width:560px){.wg-badge{display:none}}
</style>
</head>
<body>
<main class="wg-app">
  <header class="wg-header">
    <div class="wg-title" id="wg-title">Big G TV is Off Air (for now)</div>
    <div class="wg-spacer"></div>
    <div class="wg-badge">
      <span class="dot" id="wg-dot"></span>
      <span id="wg-live-text">Off Air</span>
    </div>
  </header>

  <section class="wg-body">
    <div class="wg-stage">
      <div class="wg-video" id="wg-video">
        <iframe id="yt-embed" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
      </div>
      <div class="wg-slideshow" id="wg-slideshow"></div>
      <div class="wg-debug" id="wg-debug"></div>
    </div>
  </section>
</main>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
(() => {
  const config = {
    channelId: 'UCaR9jZW5TJNrSg7w70czrsw',
    youtubeApiKey: 'AIzaSyB1seR1hQDpeJtkxml0R8lyitpqldAGzA0',

    // Data API poll (worked earlier for you)
    apiPollMs: 15000,

    // Fallback probe (in case API fails / returns empty)
    probeMs: 20000,

    slideSeconds: 8,
    slides: [
      'WGNS.png?v=1767423572',
      'BGTV.png?v=1767423572',
      'PTS.png?v=1767423572',
      'RWX.png?v=1767423572'
    ]
  };

  const titleEl = document.getElementById('wg-title');
  const dot     = document.getElementById('wg-dot');
  const liveTxt = document.getElementById('wg-live-text');
  const videoWrap = document.getElementById('wg-video');
  const slideshowWrap = document.getElementById('wg-slideshow');
  const iframeEl = document.getElementById('yt-embed');
  const dbg = document.getElementById('wg-debug');

  const debugOn = location.hash.includes('debug');
  if (debugOn) dbg.classList.add('on');

  let mode = 'offair'; // offair | live
  let liveVideoId = null;

  // slideshow
  let slideTimer = null;
  let activeIdx = 0;

  // YT player for fallback probe
  let ytPlayer = null;
  let probeTimer = null;

  function log(msg) {
    if (!debugOn) return;
    const ts = new Date().toLocaleTimeString();
    dbg.textContent = `[${ts}] ${msg}\n` + dbg.textContent.slice(0, 1800);
  }

  function setUI(live) {
    dot.classList.toggle('live', !!live);
    liveTxt.textContent = live ? 'LIVE' : 'Off Air';
    titleEl.textContent = live ? 'Big G TV â€¢ LIVE' : 'Big G TV is Off Air (for now)';
    videoWrap.classList.toggle('is-on', !!live);
    slideshowWrap.classList.toggle('is-off', !!live);
  }

  function setMode(next) {
    if (mode === next) return;
    mode = next;
    setUI(mode === 'live');
    log(`MODE => ${mode}`);
  }

  function renderSlides() {
    const slidesHtml = config.slides.map((src, i) =>
      `<div class="wg-slide${i===0?' is-active':''}" style="--bgimg: url('${src}');"></div>`
    ).join('');
    slideshowWrap.innerHTML = slidesHtml;
    activeIdx = 0;
    startSlideshow();
  }

  function startSlideshow() {
    stopSlideshow();
    const slides = Array.from(slideshowWrap.querySelectorAll('.wg-slide'));
    if (!slides.length) return;
    slides.forEach((s,i)=>s.classList.toggle('is-active', i===activeIdx));
    slideTimer = setInterval(() => {
      const prev = activeIdx;
      activeIdx = (activeIdx + 1) % slides.length;
      slides[prev].classList.remove('is-active');
      slides[activeIdx].classList.add('is-active');
    }, Math.max(2000, config.slideSeconds * 1000));
  }
  function stopSlideshow() { if (slideTimer) { clearInterval(slideTimer); slideTimer=null; } }

  function embedSrcFromVideoId(vid) {
    const origin = (location.origin && location.origin !== 'null') ? '&origin=' + encodeURIComponent(location.origin) : '';
    return 'https://www.youtube-nocookie.com/embed/' + encodeURIComponent(vid)
      + '?autoplay=1&mute=1&playsinline=1&rel=0&modestbranding=1' + origin;
  }

  function setIframeToLiveVideo() {
    if (!liveVideoId) return;
    const nextSrc = embedSrcFromVideoId(liveVideoId);
    if (iframeEl.src !== nextSrc) {
      iframeEl.src = nextSrc;
      log(`IFRAME => videoId=${liveVideoId}`);
    }
  }

  // -------- Primary: Data API live search ----------
  async function pollDataApi() {
    const url = 'https://www.googleapis.com/youtube/v3/search?part=id&channelId='
      + encodeURIComponent(config.channelId)
      + '&eventType=live&type=video&maxResults=1&key='
      + encodeURIComponent(config.youtubeApiKey);

    try {
      const res = await fetch(url, { cache:'no-store' });
      const text = await res.text();
      if (!res.ok) {
        log(`API HTTP ${res.status}: ${text.slice(0,140)}`);
        return false;
      }
      let json;
      try { json = JSON.parse(text); } catch(e) {
        log('API parse error');
        return false;
      }
      const items = json.items || [];
      const isLive = items.length > 0 && items[0].id && items[0].id.videoId;
      log(`API ok. items=${items.length} live=${!!isLive}`);

      if (isLive) {
        liveVideoId = items[0].id.videoId;
        setIframeToLiveVideo();
        setMode('live');
        return true;
      } else {
        setMode('offair');
        return false;
      }
    } catch (e) {
      log(`API fetch error: ${e && e.message ? e.message : e}`);
      return false;
    }
  }

  // -------- Fallback: Player probe on /live_stream ----------
  function ensureProbePlayer() {
    if (!window.YT || !YT.Player) return;

    // If already playing, keep it.
    if (ytPlayer) return;

    // Build a hidden-ish probe player on the same iframe element
    // We'll set it to live_stream and watch for PLAYING/BUFFERING.
    try {
      // reset iframe to live_stream mode
      const origin = (location.origin && location.origin !== 'null') ? '&origin=' + encodeURIComponent(location.origin) : '';
      iframeEl.src = 'https://www.youtube-nocookie.com/embed/live_stream?channel='
        + encodeURIComponent(config.channelId)
        + '&autoplay=1&mute=1&playsinline=1&rel=0' + origin + '&_=' + Date.now();

      ytPlayer = new YT.Player('yt-embed', {
        events: {
          onReady: (e) => {
            log('Probe player ready');
            try { e.target.playVideo(); } catch(_e){}
          },
          onStateChange: (e) => {
            // 1 playing, 3 buffering
            log(`Probe state=${e.data}`);
            if (e.data === 1 || e.data === 3) {
              // if Data API couldn't find videoId but playback started, we're live:
              setMode('live');
            }
          },
          onError: (e) => {
            log(`Probe error code=${e.data}`);
          }
        }
      });
    } catch(e) {
      log('Probe init failed');
      ytPlayer = null;
    }
  }

  function resetProbePlayer() {
    if (ytPlayer && ytPlayer.destroy) {
      try { ytPlayer.destroy(); } catch(_e){}
    }
    ytPlayer = null;
  }

  // Hybrid loop: try Data API; if it fails repeatedly, use probe.
  let apiFailStreak = 0;

  async function tick() {
    const apiLive = await pollDataApi();
    if (apiLive) {
      apiFailStreak = 0;
      resetProbePlayer();
      return;
    }

    // If API isn't returning live, we still keep an occasional probe,
    // because some live configs can be weird.
    apiFailStreak++;
    if (apiFailStreak >= 3) {
      ensureProbePlayer();
      apiFailStreak = 0; // don't spam
    }
  }

  // Wake/focus: run immediately
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      log('Tab visible: immediate tick');
      tick();
    }
  });

  // Boot
  renderSlides();
  setUI(false);

  // Start loop
  tick();
  setInterval(tick, config.apiPollMs);

  // YouTube API ready (for probe fallback)
  window.onYouTubeIframeAPIReady = () => {
    log('YT IFrame API ready');
    // probe timer (only if needed)
    probeTimer = setInterval(() => {
      if (mode === 'offair') ensureProbePlayer();
    }, config.probeMs);
  };
})();
</script>
</body>
</html>
