<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WGNS / Big G TV Lobby</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#000;
      --fade: 900ms;
    }
    html, body { height:100%; margin:0; background:var(--bg); overflow:hidden; }
    #wrap { position:relative; width:100%; height:100%; background:var(--bg); }
    #playerLayer, #slideshowLayer { position:absolute; inset:0; }
    #slideshowLayer { display:block; background:var(--bg); }
    #playerLayer { display:none; background:var(--bg); }
    #slideshowLayer img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      opacity:0;
      transition: opacity var(--fade) linear;
    }
    #slideshowLayer img.show{ opacity:1; }

    /* Small status badge (optional) */
    #badge{
      position:absolute; left:18px; bottom:18px;
      padding:8px 10px; border-radius:12px;
      background:rgba(0,0,0,.55);
      color:#fff;
      font: 600 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      letter-spacing:.2px; user-select:none;
      backdrop-filter: blur(6px);
      z-index: 10;
    }
    #badge small{ display:block; opacity:.75; font-weight:500; margin-top:2px; }
    #badge.offline::before{ content:"● "; color:#ff5252; }
    #badge.online::before{ content:"● "; color:#35d07f; }

    #twitch-embed, iframe { width:100% !important; height:100% !important; }
  </style>

  <!-- Twitch embed SDK -->
  <script src="https://player.twitch.tv/js/embed/v1.js"></script>
</head>
<body>
  <div id="wrap">
    <div id="slideshowLayer" aria-label="Offline slideshow"></div>

    <div id="playerLayer" aria-label="Twitch player">
      <div id="twitch-embed"></div>
    </div>

    <div id="badge" class="offline">OFFLINE<small>Showing lobby loop</small></div>
  </div>

  <script>
    // ===================== CONFIG =====================
    const CONFIG = {
      channel: "wgnsbiggtv",

      // IMPORTANT: Start with autoplay OFF so Twitch can’t “helpfully” play an old VOD.
      autoplay: false,
      muted: false,
      volume: 0.5,

      showBadge: true,

      // Images are in the SAME folder as index.html (repo root on GitHub Pages)
      slides: [
        "WGNS.png",
        "BGTV.png",
        "PTS.png",
        "RWX.png"
      ],

      slideMs: 10000,

      // Backup live check (no setup). If you don’t want it, set to 0.
      pollMs: 30000,

      // Recreate the player occasionally while offline (helps “stuck offline/live” edge cases)
      offlineRecreateMs: 60000,

      // After we switch to “online”, wait a beat then confirm we didn’t get a VOD.
      vodGuardDelayMs: 1500,
    };

    // ===================== DOM =====================
    const slideshowLayer = document.getElementById("slideshowLayer");
    const playerLayer = document.getElementById("playerLayer");
    const badge = document.getElementById("badge");

    function setBadge(state, note){
      if (!CONFIG.showBadge) { badge.style.display = "none"; return; }
      badge.style.display = "block";
      badge.classList.toggle("online", state === "online");
      badge.classList.toggle("offline", state !== "online");
      badge.childNodes[0].nodeValue = (state === "online" ? "LIVE" : "OFFLINE");
      badge.querySelector("small").textContent = note || (state === "online" ? "Playing Twitch stream" : "Showing lobby loop");
    }

    // ===================== SLIDESHOW =====================
    let slideEls = [];
    let slideIdx = 0;
    let slideTimer = null;

    function buildSlides(){
      slideshowLayer.innerHTML = "";
      slideEls = CONFIG.slides.map(src => {
        const img = document.createElement("img");
        img.src = src;
        img.alt = "";
        slideshowLayer.appendChild(img);
        return img;
      });
      slideIdx = 0;
      if (slideEls[0]) slideEls[0].classList.add("show");
    }

    function startSlideshow(){
      if (slideTimer) return;
      if (!slideEls.length) buildSlides();
      slideTimer = setInterval(() => {
        if (!slideEls.length) return;
        slideEls[slideIdx].classList.remove("show");
        slideIdx = (slideIdx + 1) % slideEls.length;
        slideEls[slideIdx].classList.add("show");
      }, CONFIG.slideMs);
    }

    function stopSlideshow(){
      if (slideTimer) clearInterval(slideTimer);
      slideTimer = null;
    }

    // ===================== VIEW TOGGLE =====================
    function showOffline(note){
      playerLayer.style.display = "none";
      slideshowLayer.style.display = "block";
      startSlideshow();
      setBadge("offline", note || "Showing lobby loop");
    }

    function showOnline(note){
      slideshowLayer.style.display = "none";
      playerLayer.style.display = "block";
      stopSlideshow();
      setBadge("online", note || "Playing Twitch stream");
    }

    // ===================== TWITCH PLAYER =====================
    let player = null;
    let lastMode = "offline";

    function parentDomains(){
      // Required by Twitch: must match the hosting domain
      const host = window.location.hostname;
      return host ? [host] : [];
    }

    function createPlayer({ autoplay } = {}){
      const auto = (typeof autoplay === "boolean") ? autoplay : CONFIG.autoplay;

      document.getElementById("twitch-embed").innerHTML = "";

      player = new Twitch.Player("twitch-embed", {
        channel: CONFIG.channel,
        parent: parentDomains(),
        autoplay: auto,
        muted: CONFIG.muted,
      });

      try { player.setVolume(CONFIG.volume); } catch(e) {}

      player.addEventListener(Twitch.Player.ONLINE, () => {
        // ONLINE event can sometimes happen even if Twitch starts a VOD.
        // We switch online, then run a VOD guard check shortly after.
        goOnline("Twitch says ONLINE");
      });

      player.addEventListener(Twitch.Player.OFFLINE, () => {
        goOffline("Twitch says OFFLINE");
      });
    }

    // ===================== VOD GUARD =====================
    function isProbablyVOD(){
      // We can’t read inside the Twitch iframe (cross-domain),
      // but we *can* inspect the iframe src. VODs usually include "video=" or "/videos/".
      const iframe = document.querySelector("#twitch-embed iframe");
      if (!iframe) return false;
      const src = iframe.getAttribute("src") || "";
      return src.includes("video=") || src.includes("/videos/");
    }

    let vodGuardTimer = null;
    function scheduleVodGuard(){
      if (vodGuardTimer) clearTimeout(vodGuardTimer);
      vodGuardTimer = setTimeout(() => {
        if (playerLayer.style.display === "block" && isProbablyVOD()){
          // This is the exact bug you hit: an old stream/VOD is playing while you’re offline.
          goOffline("Blocked a VOD (offline)");
        }
      }, CONFIG.vodGuardDelayMs);
    }

    // ===================== MODE CONTROL =====================
    function goOffline(reason){
      lastMode = "offline";
      showOffline(reason);
      // While offline, keep autoplay OFF so Twitch can’t start a VOD.
      CONFIG.autoplay = false;
    }

    function goOnline(reason){
      lastMode = "online";
      // When we decide to go online, recreate player with autoplay ON (so it actually starts live).
      CONFIG.autoplay = true;
      showOnline(reason);
      createPlayer({ autoplay: true });
      scheduleVodGuard();
    }

    // ===================== BACKUP LIVE CHECK (NO SETUP) =====================
    async function checkLiveDecapi(){
      // Returns "offline" or uptime string. Treat non-offline as live-ish.
      const url = `https://decapi.me/twitch/uptime/${encodeURIComponent(CONFIG.channel)}?redirect=true`;
      try{
        const res = await fetch(url, { cache: "no-store" });
        const text = (await res.text()).trim().toLowerCase();
        return text && text !== "offline";
      } catch(e){
        return null; // unknown
      }
    }

    // ===================== INIT =====================
    (function init(){
      buildSlides();
      goOffline("Checking stream status…");
      createPlayer({ autoplay: false }); // start safe

      // Backup polling loop (optional)
      if (CONFIG.pollMs > 0){
        setInterval(async () => {
          const live = await checkLiveDecapi();
          if (live === true) {
            // Only switch online if we aren’t already
            if (lastMode !== "online") goOnline("Status check: LIVE");
            else scheduleVodGuard();
          } else if (live === false) {
            if (lastMode !== "offline") goOffline("Status check: OFFLINE");
          } else {
            // unknown, keep current mode
            setBadge(lastMode === "online" ? "online" : "offline", "Status check failed (network)");
          }
        }, CONFIG.pollMs);
      }

      // Recreate player periodically while offline (still with autoplay OFF)
      setInterval(() => {
        if (lastMode === "offline") createPlayer({ autoplay: false });
      }, CONFIG.offlineRecreateMs);

      // Press F to toggle fullscreen
      document.addEventListener("keydown", (e) => {
        if (e.key.toLowerCase() === "f") {
          if (!document.fullscreenElement) document.documentElement.requestFullscreen?.();
          else document.exitFullscreen?.();
        }
      });
    })();
  </script>
</body>
</html>
