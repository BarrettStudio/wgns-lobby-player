<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Big G TV Lobby</title>
<style>
:root { --bg:#0b1220; --panel:rgba(255,255,255,.92); --border:rgba(255,255,255,.14); --text:#0f172a; --radius:18px; --shadow:0 18px 48px rgba(0,0,0,.25); }
html,body{height:100%}
body{
  margin:0; min-height:100vh;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  color:var(--text);
  background: var(--bg);
  display:grid; place-items:center;
  padding:clamp(14px,3vw,28px);
  box-sizing:border-box;
  position:relative;
  overflow:hidden;
}
body::before{
  content:"";
  position:absolute; inset:-18%;
  background:
    radial-gradient(1200px 600px at 15% 10%, rgba(239,68,68,.24), transparent 60%),
    radial-gradient(900px 520px at 85% 20%, rgba(249,115,22,.18), transparent 55%),
    radial-gradient(1100px 700px at 50% 100%, rgba(59,130,246,.12), transparent 60%);
  filter: blur(28px);
  transform: translate3d(0,0,0) scale(1.10);
  animation: bgDrift 18s ease-in-out infinite alternate;
  z-index:-1;
}
body::after{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(1200px 700px at 50% 40%, rgba(0,0,0,0), rgba(0,0,0,.30));
  z-index:-1;
}
@keyframes bgDrift{
  0%   { transform: translate3d(-2.5%, -1.5%, 0) scale(1.10); opacity:.95; }
  50%  { transform: translate3d(2.5%, 1.2%, 0) scale(1.12); opacity:1; }
  100% { transform: translate3d(-1.0%, 2.0%, 0) scale(1.11); opacity:.97; }
}
.wg-app{
  width:min(1200px,100%);
  height:min(720px,100%);
  max-height:calc(100vh - clamp(28px, 6vw, 56px));
  background:linear-gradient(180deg,var(--panel),rgba(255,255,255,.86));
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex; flex-direction:column;
  backdrop-filter:blur(10px);
}
.wg-header{
  display:flex; align-items:center; gap:14px;
  padding:14px 16px;
  border-bottom:1px solid rgba(15,23,42,.08);
  background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.88));
  flex:0 0 auto;
}
.wg-title{font-weight:950; letter-spacing:-.02em; font-size:1.02rem; line-height:1.1}
.wg-spacer{margin-left:auto}
.wg-badge{
  display:inline-flex; align-items:center; gap:8px;
  padding:7px 10px; border-radius:999px;
  border:1px solid rgba(15,23,42,.10);
  background:rgba(255,255,255,.75);
  font-weight:900;
  color:rgba(15,23,42,.85);
}
.dot{width:9px; height:9px; border-radius:99px; background:#9ca3af}
.dot.live{background:#22c55e}
.wg-body{padding:16px; flex:1 1 auto; min-height:0; display:flex}
.wg-stage{
  position:relative;
  width:100%; height:100%;
  border-radius:16px;
  overflow:hidden;
  background:#000;
  border:1px solid rgba(15,23,42,.10);
}
.wg-video{ position:absolute; inset:0; opacity:0; transition: opacity .7s ease-in-out; }
.wg-video.is-on{opacity:1}
#yt-holder, #yt-holder iframe{position:absolute; inset:0; width:100%; height:100%; border:none}
.wg-slideshow{ position:absolute; inset:0; opacity:1; transition: opacity .7s ease-in-out; }
.wg-slideshow.is-off{opacity:0; pointer-events:none}
.wg-slideshow::after{
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(900px 540px at 50% 45%, rgba(255,255,255,.10), transparent 60%),
    radial-gradient(1200px 700px at 20% 20%, rgba(239,68,68,.10), transparent 60%),
    radial-gradient(1000px 700px at 80% 70%, rgba(59,130,246,.10), transparent 60%);
  pointer-events:none;
  mix-blend-mode:soft-light;
  z-index:3;
}
.wg-slide{ position:absolute; inset:0; opacity:0; transition: opacity 1.2s ease-in-out; z-index:1; }
.wg-slide.is-active{opacity:1}
.wg-slide::before{
  content:"";
  position:absolute; inset:-4%;
  background-image: var(--bgimg);
  background-size:cover;
  background-position:center;
  transform:scale(1);
  filter:saturate(1.02);
}
.wg-slide.is-active::before{ animation: wgPulse 6s ease-in-out infinite; }
@keyframes wgPulse { 0%{transform:scale(1)} 50%{transform:scale(1.04)} 100%{transform:scale(1)} }
.wg-slide::after{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(900px 600px at 50% 50%, transparent 45%, rgba(0,0,0,.28));
  pointer-events:none;
  z-index:2;
}
.wg-debug{
  position:absolute; left:12px; bottom:12px;
  padding:10px 12px; border-radius:12px;
  background:rgba(0,0,0,.55);
  color:rgba(255,255,255,.92);
  font: 12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  display:none; z-index:10; white-space:pre-wrap;
}
.wg-debug.on{display:block}
</style>
</head>
<body>
<main class="wg-app">
  <header class="wg-header">
    <div class="wg-title" id="wg-title">Big G TV is Off Air (for now)</div>
    <div class="wg-spacer"></div>
    <div class="wg-badge">
      <span class="dot" id="wg-dot"></span>
      <span id="wg-live-text">Off Air</span>
    </div>
  </header>

  <section class="wg-body">
    <div class="wg-stage">
      <div class="wg-video" id="wg-video">
        <div id="yt-holder">
          <iframe id="yt-embed" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
        </div>
      </div>
      <div class="wg-slideshow" id="wg-slideshow"></div>
      <div class="wg-debug" id="wg-debug"></div>
    </div>
  </section>
</main>

<script>
(() => {
  const CACHE_BUST = '1767664970';

  const config = {
    channelId: 'UCaR9jZW5TJNrSg7w70czrsw',
    handle: 'newsradiowgns',
    iframeReloadMs: 9000,
    detectPollMs: 900,
    settleLiveMs: 2500,
    stuckLiveMs: 8000,
    slides: [
      'WGNS.png?v=' + CACHE_BUST,
      'BGTV.png?v=' + CACHE_BUST,
      'PTS.png?v=' + CACHE_BUST,
      'RWX.png?v=' + CACHE_BUST
    ],
    slideSeconds: 8
  };

  const titleEl = document.getElementById('wg-title');
  const dot     = document.getElementById('wg-dot');
  const liveTxt = document.getElementById('wg-live-text');
  const videoWrap = document.getElementById('wg-video');
  const slideshowWrap = document.getElementById('wg-slideshow');
  const dbg = document.getElementById('wg-debug');

  const debugOn = location.hash.includes('debug');
  if (debugOn) dbg.classList.add('on');

  let mode = 'offair';
  let player = null;
  let reloadTimer = null;
  let detectTimer = null;
  let initTimer = null;

  let liveConfidenceStartedAt = null;
  let lastPlayableAt = 0;
  let lastErrorAt = 0;

  let slideTimer = null;
  let activeIdx = 0;

  function log(msg){
    if (!debugOn) return;
    const ts = new Date().toLocaleTimeString();
    dbg.textContent = '[' + ts + '] ' + msg + '\n' + dbg.textContent.slice(0, 1700);
  }

  function setUI(live){
    dot.classList.toggle('live', !!live);
    liveTxt.textContent = live ? 'LIVE' : 'Off Air';
    titleEl.textContent = live ? 'Big G TV â€¢ LIVE' : 'Big G TV is Off Air (for now)';
    videoWrap.classList.toggle('is-on', !!live);
    slideshowWrap.classList.toggle('is-off', !!live);
  }
  function setMode(next){
    if (mode === next) return;
    mode = next;
    setUI(mode === 'live');
    log('MODE => ' + mode);

    if (mode === 'live'){
      stopSlideshow();
      // stop both detectors once we're live (player watchdog will keep it healthy)
      stopLiveProbe();
      stopLiveDetect();
    } else {
      // offair
      startSlideshow();
      startLiveProbe();
      startLiveDetect();
    }
  }

  function renderSlides(){
    const slidesHtml = config.slides.map((src, i) =>
      '<div class="wg-slide' + (i===0?' is-active':'') + '" style="--bgimg: url(\'' + src + '\');"></div>'
    ).join('');
    slideshowWrap.innerHTML = slidesHtml;
    activeIdx = 0;
    startSlideshow();
  }
  function startSlideshow(){
    stopSlideshow();
    const slides = Array.from(slideshowWrap.querySelectorAll('.wg-slide'));
    if (!slides.length) return;
    slides.forEach((s,i)=>s.classList.toggle('is-active', i===activeIdx));
    slideTimer = setInterval(() => {
      const prev = activeIdx;
      activeIdx = (activeIdx + 1) % slides.length;
      slides[prev].classList.remove('is-active');
      slides[activeIdx].classList.add('is-active');
    }, Math.max(2000, config.slideSeconds * 1000));
  }
  function stopSlideshow(){ if (slideTimer) { clearInterval(slideTimer); slideTimer=null; } }

  function liveIframeSrc(){
    return 'https://www.youtube-nocookie.com/embed/live_stream?channel='
      + encodeURIComponent(config.channelId)
      + '&autoplay=1&mute=1&playsinline=1&rel=0&modestbranding=1&enablejsapi=1'
      + '&_=' + Date.now();
  }

  let iframeEl = document.getElementById('yt-embed');

  function reloadIframe(){
    iframeEl.src = liveIframeSrc();
    log('iframe reload');
  }

  
  // --- Reliable LIVE detection (works on static hosting) ---
  // We fetch the channel /live page via a CORS-friendly proxy and extract the primary og:url / canonical watch URL.
  // This avoids the stale `embed/live_stream?channel=` issue that often requires a full page refresh.
  const PROXIES = [
    // Most reliable and lightweight
    (u) => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(u),
    // Fallback (can rate limit if hit too frequently)
    (u) => 'https://r.jina.ai/' + u
  ];

  const LIVE_URLS = [
    () => 'https://www.youtube.com/channel/' + config.channelId + '/live',
    () => 'https://www.youtube.com/@' + config.handle + '/live'
  ];

  let probeTimer = null;
  let probeBackoffMs = 15000; // starts at 15s
  let probeInFlight = false;

  function parsePrimaryLiveVideoId(htmlText){
    if (!htmlText) return null;
    // Prefer og:url (points to the currently surfaced primary video for /live when live is active)
    let m = htmlText.match(/property=["']og:url["'][^>]*content=["']https?:\/\/www\.youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/i);
    if (m && m[1]) return m[1];

    // Fallback: canonical link
    m = htmlText.match(/rel=["']canonical["'][^>]*href=["']https?:\/\/www\.youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/i);
    if (m && m[1]) return m[1];

    return null;
  }

  async function fetchText(url){
    const r = await fetch(url, { cache: 'no-store' });
    return { status: r.status, text: await r.text() };
  }

  async function probeForLiveVideoId(){
    if (mode === 'live') return null;
    if (probeInFlight) return null;
    probeInFlight = true;

    try {
      for (const liveUrlFn of LIVE_URLS){
        const liveUrl = liveUrlFn();
        for (const proxyFn of PROXIES){
          const proxied = proxyFn(liveUrl);
          let res;
          try {
            res = await fetchText(proxied);
          } catch (e) {
            log('probe ERR fetch ' + proxied + ' :: ' + (e && e.message ? e.message : e));
            continue;
          }
          log('probe ' + res.status + ' ' + proxied);
          if (res.status === 429) {
            // rate limited: back off and stop trying other proxies for a bit
            probeBackoffMs = Math.min(probeBackoffMs * 2, 180000);
            return null;
          }
          if (res.status < 200 || res.status >= 300) continue;

          const vid = parsePrimaryLiveVideoId(res.text);
          if (vid) return vid;
        }
      }
      return null;
    } finally {
      probeInFlight = false;
    }
  }

  function videoEmbedSrc(videoId){
    return 'https://www.youtube-nocookie.com/embed/'
      + encodeURIComponent(videoId)
      + '?autoplay=1&mute=1&playsinline=1&rel=0&modestbranding=1&enablejsapi=1'
      + '&_=' + Date.now();
  }

  async function tickLiveProbe(){
    try {
      const vid = await probeForLiveVideoId();
      if (vid && isRealVideoId(vid)) {
        iframeEl.src = videoEmbedSrc(vid);
        log('SWITCH iframe -> videoId ' + vid);
        setMode('live');
        stopSlideshow();
        stopLiveDetect();
      } else {
        // If not live, gradually relax backoff (but never below 15s)
        probeBackoffMs = Math.max(15000, Math.floor(probeBackoffMs * 0.9));
      }
    } catch (e) {
      log('probe ERR ' + (e && e.message ? e.message : e));
      probeBackoffMs = Math.min(probeBackoffMs * 2, 180000);
    } finally {
      // reschedule with current backoff
      if (probeTimer) clearTimeout(probeTimer);
      if (mode !== 'live') probeTimer = setTimeout(tickLiveProbe, probeBackoffMs);
    }
  }

  function startLiveProbe(){
    if (probeTimer) return;
    probeBackoffMs = 15000;
    tickLiveProbe();
  }

  function stopLiveProbe(){
    if (probeTimer) { clearTimeout(probeTimer); probeTimer = null; }
    probeInFlight = false;
  }
  // --- end LIVE detection ---

function isLiveState(s){ return s === 1 || s === 3; }
  function isRealVideoId(vid){
    if (!vid) return false;
    if (vid === 'live_stream') return false;
    if (vid.length < 10) return false;
    return true;
  }

  function noteLiveEvidence(isLive){
    const now = Date.now();
    if (isLive){
      if (!liveConfidenceStartedAt) liveConfidenceStartedAt = now;
      const elapsedMs = now - liveConfidenceStartedAt;
      if (debugOn) log('live evidence ' + (elapsedMs/1000).toFixed(1) + 's');
      if (elapsedMs >= config.settleLiveMs){
        setMode('live');
      }
    } else {
      liveConfidenceStartedAt = null;
      setMode('offair');
    }
  }

  function detectLive(){
    if (!player) return;
    let st = null;
    try { st = player.getPlayerState(); } catch(e){}
    let vid = '';
    try {
      const vd = player.getVideoData && player.getVideoData();
      vid = (vd && (vd.video_id || vd.videoId)) ? (vd.video_id || vd.videoId) : '';
    } catch(e){}

    const liveByState = (typeof st === 'number') && isLiveState(st);
    const liveByVideoId = isRealVideoId(vid);

    log('state=' + st + ' vid=' + (vid||'(none)') + ' liveByState=' + liveByState + ' liveByVid=' + liveByVideoId);
    noteLiveEvidence(liveByState || liveByVideoId);
  }

  function initPlayerNow(){
    if (!window.YT || !YT.Player) return false;
    if (player) return true;

    log('Init YT.Player...');
    try {
      player = new YT.Player('yt-embed', {
        events: {
          onReady: (e) => {
            log('YT ready');
            try { e.target.mute(); } catch(_e){}
            try { e.target.playVideo(); } catch(_e){}
            if (!detectTimer) detectTimer = setInterval(detectLive, config.detectPollMs);
          },
          onStateChange: (e) => {
            log('onStateChange=' + e.data);
            if (isLiveState(e.data)) {
              lastPlayableAt = Date.now();
              noteLiveEvidence(true);
            }
          },
          onError: (e) => {
            log('onError=' + e.data);
            lastErrorAt = Date.now();
            liveConfidenceStartedAt = null;
            setMode('offair');
          }
        }
      });
      return true;
    } catch(e) {
      log('YT init threw');
      return false;
    }
  }

  function startInitFallback(){
    if (initTimer) return;
    initTimer = setInterval(() => {
      const ok = initPlayerNow();
      if (ok){
        clearInterval(initTimer);
        initTimer = null;
        log('YT init fallback success');
      }
    }, 500);
  }

  function rebuildPlayerAfterReload(){
    if (player && player.destroy){
      try { player.destroy(); } catch(_e){}
    }
    player = null;
    liveConfidenceStartedAt = null;
    setTimeout(() => initPlayerNow(), 250);
  }

  function hardRebuildIframe(){
    log('HARD rebuild iframe');
    const holder = document.getElementById('yt-holder');
    holder.innerHTML = '<iframe id="yt-embed" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>';
    iframeEl = document.getElementById('yt-embed');
    reloadIframe();
    rebuildPlayerAfterReload();
  }

  function startReloadLoop(){
    if (reloadTimer) return;
    reloadTimer = setInterval(() => {
      const now = Date.now();
      const recentlyPlayable = (now - lastPlayableAt) < config.stuckLiveMs;
      const recentlyErrored  = (now - lastErrorAt) < config.stuckLiveMs;

      if (mode === 'offair'){
        reloadIframe();
        rebuildPlayerAfterReload();
        return;
      }

      if (mode === 'live' && !recentlyPlayable){
        log('LIVE but not playable -> self-heal');
        if (recentlyErrored) hardRebuildIframe();
        else { reloadIframe(); rebuildPlayerAfterReload(); }
      }
    }, config.iframeReloadMs);
  }

  document.addEventListener('visibilitychange', () => {
    if (!document.hidden){
      log('visible -> reload');
      reloadIframe();
      rebuildPlayerAfterReload();
      setTimeout(() => detectLive(), 1000);
    }
  });

  renderSlides();
  setMode('offair');
  reloadIframe();

  // Start robust live probing (independent of YouTube player state)
  startLiveProbe();

  const s = document.createElement('script');
  s.src = 'https://www.youtube.com/iframe_api';
  s.async = true;
  document.head.appendChild(s);

  window.onYouTubeIframeAPIReady = () => {
    log('YT IFrame API ready');
    initPlayerNow();
  };

  startInitFallback();
  startReloadLoop();
})();
</script>
</body>
</html>
